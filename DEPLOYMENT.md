# 集成测试说明

本文档详细说明了如何运行 `librdkafka-cffi` 项目的集成测试，以及测试所覆盖的功能范围和相关依赖。

## 概述

集成测试旨在验证项目的核心功能能否在真实环境中（即与一个正在运行的 Kafka Broker 交互）正常工作。测试覆盖了从消息生产到消费的完整端到端流程。

## 已测试功能

通过本次集成测试，以下核心功能已得到验证：

### 生产者 (Producer)

- **功能**: 初始化生产者并连接到 Kafka Broker。
- **预期现象**: 生产者能够成功建立与 Kafka 容器的网络连接。

- **功能**: 异步发送消息到指定的 Kafka 主题。
- **预期现象**: `produce()` 方法调用成功，消息被发送到 Broker 的缓冲区，没有立即返回错误。

- **功能**: 刷新（`flush`）生产者缓冲区，确保消息被发送。
- **预期现象**: `flush()` 方法能够成功阻塞并等待，直到消息被 Broker 确认接收。

### 消费者 (Consumer)

- **功能**: 初始化消费者，设置消费组 ID，并连接到 Kafka Broker。
- **预期现象**: 消费者能够成功建立与 Kafka 容器的网络连接。

- **功能**: 订阅一个或多个 Kafka 主题。
- **预期现象**: `subscribe()` 方法调用成功，消费者加入消费组并准备好从订阅的主题拉取消息。

- **功能**: 从订阅的主题轮询（`poll`）消息。
- **预期现象**: `poll()` 方法能够成功拉取到由生产者发送的消息。

- **功能**: 验证接收消息的完整性。
- **预期现象**: 消费者接收到的消息的 `key` 和 `value` 与生产者发送的完全一致。

- **功能**: 关闭消费者并释放资源。
- **预期现象**: `close()` 方法能够被成功调用，释放底层连接和资源。

## 如何运行集成测试

### 依赖

在运行测试之前，请确保您的环境中已安装以下软件：

- **Docker**: 用于运行 Kafka 和 Zookeeper 容器。
- **Docker Compose**: 用于编排和管理 Docker 容器。
- **Python 3.x**: 测试脚本的运行环境。
- **pip**: 用于安装 Python 依赖包。

### 步骤

请按照以下步骤操作以复现集成测试：

1.  **启动 Kafka 服务**

    在项目根目录下，运行以下命令以后台模式启动 Kafka 和 Zookeeper 服务。`sudo` 是必需的。

    ```bash
    sudo docker compose up -d
    ```

2.  **安装项目及测试依赖**

    此命令将安装 `librdkafka-cffi` 包本身及其在 `setup.py` 中定义的依赖项。

    ```bash
    pip install .
    ```

3.  **运行集成测试**

    执行以下命令来运行位于 `tests/test_integration.py` 的测试脚本。

    ```bash
    python3 -m unittest tests/test_integration.py
    ```

    如果一切顺利，您将看到测试通过的提示，类似于 `Ran 1 test in ...s` 和 `OK`。

4.  **清理环境**

    测试完成后，运行以下命令来停止并移除所有相关的 Docker 容器、网络和数据卷，以保持环境的整洁。

    ```bash
    sudo docker compose down -v
    ```